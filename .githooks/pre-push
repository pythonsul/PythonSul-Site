#!/bin/sh
# Pre-push hook for Hugo site
# Commit format: type: message
# Allowed types: feat, fix, docs, style, refactor, test, chore

echo "üöÄ Running Hugo pre-push checks..."

# === 1. Run Makefile's check task ===
if ! make check; then
    echo "‚ùå Hugo environment check failed. Push aborted."
    exit 1
fi

# === 2. Build site using Makefile ===
echo "üõ† Building Hugo site..."
if ! make build; then
    echo "‚ùå Hugo build failed. Push aborted."
    exit 1
fi

# === 3. Commit message validation ===
echo "üîç Validating commit messages..."
while read local_ref local_sha remote_ref remote_sha
do
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        range="$local_sha"  # New branch
    else
        range="$remote_sha..$local_sha"  # Updating branch
    fi
    
    for commit in $(git rev-list "$range"); do
        msg=$(git log --format=%s -n 1 "$commit")
        
        # Format: type: message
        if ! echo "$msg" | grep -Eq '^(feat|fix|docs|style|refactor|test|chore): [a-z0-9]'; then
            echo "‚ùå Commit message does not follow required format:"
            echo "   $msg"
            echo "Expected: <type>: <message>"
            echo "Allowed types: feat, fix, docs, style, refactor, test, chore"
            exit 1
        fi
    done
done

echo "‚úÖ All checks passed. Pushing..."
exit 0
